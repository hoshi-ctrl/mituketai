<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>位置情報共有</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 400px; width: 100%; margin-bottom: 10px; }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        textarea { width: 100%; height: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>位置情報共有</h1>
        
        <div id="locationShareSection">
            <h2>自分の位置を共有</h2>
            <button onclick="shareLocation()">現在地を取得</button>
            <textarea id="locationText" readonly placeholder="ここに位置情報が表示されます"></textarea>
            <button onclick="copyLocation()">位置情報をコピー</button>
        </div>

        <div id="locationTrackSection">
            <h2>相手の位置を表示</h2>
            <textarea id="pasteLocationText" placeholder="相手からコピーした位置情報を貼り付けてください"></textarea>
            <button onclick="showLocation()">位置を地図に表示</button>
        </div>

        <div id="map"></div>
    </div>

    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let myLocation = null;
        let otherLocation = null;
        const markers = [];

        function shareLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // 位置情報をテキストエリアに表示
                    const locationText = `緯度: ${lat}, 経度: ${lng}`;
                    document.getElementById('locationText').value = locationText;
                    
                    // 自分の位置情報を保存
                    myLocation = { lat, lng };
                });
            } else {
                alert('位置情報が利用できません');
            }
        }

        function copyLocation() {
            const locationText = document.getElementById('locationText');
            locationText.select();
            document.execCommand('copy');
            alert('位置情報をコピーしました');
        }

        function showLocation() {
            // 既存のマーカーをすべて削除
            markers.forEach(marker => map.removeLayer(marker));
            markers.length = 0;

            // 入力された位置情報から緯度経度を抽出
            const pasteText = document.getElementById('pasteLocationText').value;
            const latMatch = pasteText.match(/緯度:\s*([-\d.]+)/);
            const lngMatch = pasteText.match(/経度:\s*([-\d.]+)/);

            if (latMatch && lngMatch) {
                const lat = parseFloat(latMatch[1]);
                const lng = parseFloat(lngMatch[1]);

                // 相手の位置情報を保存
                otherLocation = { lat, lng };

                // 自分の位置情報があれば追加
                if (myLocation) {
                    // 自分のマーカー
                    const myMarker = L.marker([myLocation.lat, myLocation.lng], {
                        icon: L.divIcon({
                            className: 'my-marker',
                            html: '<div style="background-color: blue; width: 10px; height: 10px; border-radius: 50%;"></div>'
                        })
                    })
                    .bindPopup('自分の位置')
                    .addTo(map);
                    markers.push(myMarker);
                }

                // 相手のマーカー
                const otherMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'other-marker',
                        html: '<div style="background-color: red; width: 10px; height: 10px; border-radius: 50%;"></div>'
                    })
                })
                .bindPopup('相手の位置')
                .addTo(map);
                markers.push(otherMarker);

                // 両者の位置を含むようにマップを調整
                if (myLocation) {
                    const bounds = L.latLngBounds([myLocation.lat, myLocation.lng], [lat, lng]);
                    map.fitBounds(bounds);
                } else {
                    map.setView([lat, lng], 10);
                }
            } else {
                alert('有効な位置情報形式ではありません');
            }
        }
    </script>
</body>
</html>
