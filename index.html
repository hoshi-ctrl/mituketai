<!DOCTYPE html>
<html>
<head>
  <title>Realtime Location Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
</head>
<body>
  <div id="map" style="height: 500px;"></div>

  <script>
    // Firebaseの設定
    const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}",
            authDomain: "{{FIREBASE_AUTH_DOMAIN}}",
            databaseURL: "{{FIREBASE_DATABASE_URL}}",
            projectId: "{{FIREBASE_PROJECT_ID}}",
            storageBucket: "{{FIREBASE_STORAGE_BUCKET}}",
            messagingSenderId: "{{FIREBASE_MESSAGING_SENDER_ID}}",
            appId: "{{FIREBASE_APP_ID}}",
            measurementId: "{{MEASUREMENT_ID}}"
    };

    // Firebase初期化
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // 地図の初期化
    const map = L.map('map').setView([35.6895, 139.6917], 13); // 東京を初期表示
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // ユーザーの位置情報を保存するためのマーカー
    let markers = {};

    // ユーザーの位置情報を取得し、Realtime Databaseに保存
    function showPosition(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;

      // ユーザーIDを取得（認証済みユーザーの場合）
      const userId = auth.currentUser.uid;

      // 位置情報をRealtime Databaseに保存
      database.ref('users').child(userId).set({
        latitude: latitude,
        longitude: longitude
      });
    }

    // ユーザーの位置情報をリアルタイムに監視
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(showPosition);
    } else {
      // Geolocation APIがサポートされていない場合の処理
    }

    // Realtime Databaseから位置情報を取得し、地図に表示
    const usersRef = database.ref('users');
    usersRef.on('child_added', (snapshot) => {
      const userData = snapshot.val();
      const userId = snapshot.key;

      // マーカーが既にあれば位置を更新、なければ新規にマーカーを追加
      if (markers[userId]) {
        markers[userId].setLatLng([userData.latitude, userData.longitude]);
      } else {
        markers[userId] = L.marker([userData.latitude, userData.longitude])
          .addTo(map)
          .bindPopup(`<b>User: ${userId}</b>`)
          .openPopup();
      }
    });

    usersRef.on('child_changed', (snapshot) => {
      const userData = snapshot.val();
      const userId = snapshot.key;

      // マーカーの位置を更新
      if (markers[userId]) {
        markers[userId].setLatLng([userData.latitude, userData.longitude]);
      }
    });
  </script>
</body>
</html>
